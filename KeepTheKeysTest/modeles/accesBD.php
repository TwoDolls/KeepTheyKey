<?php

class accesBD
	{
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//--------------------------ATTRIBUTS PRIVES--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	private $hote;
	private $login;
	private $passwd;
	private $base;
	
	
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//--------------------------CONSTRUCTEUR------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	public function __construct(){
		$this->hote="localhost";
		$this->login="root";
		$this->passwd="";
		$this->base="affiliationClef";
		}
	
	
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//-----------------------------CONNECTION A LA BASE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	private function connexion(){
		$cnx = new mysqli($this->hote,$this->login,$this->passwd,$this->base);
		if(mysqli_connect_error()!=""){
			echo mysqli_connect_error();
			return 0;
			}
		else
			return $cnx;
		}
	
	
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//----------------------------CHARGEMENT DES INFORMATIONS DE LA BASE--------------------------------------------------------------------------------------------------------------------------------------------------
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	public function chargement($uneTable){
		$lesInfos=null;
		$nbTuples=0;
		//définition de la requête SQL
		$requete = "SELECT * FROM ".$uneTable;
		//exécution de la requête SQL
		$resultat=$this->execRequete($requete);
		//POUR chaque tuple retourné par la requête SQL
		while($unTuple=$resultat->fetch_row()){
			$nbChamps=0;
			//POUR chaque champ du tuple courant
			while ($nbChamps<$resultat->field_count){
				//enregistrement du champ dans la bonne case du tableau à deux dimensions
				$lesInfos[$nbTuples][$nbChamps]=$unTuple[$nbChamps];
				$nbChamps++;
				}
			$nbTuples++;				
			}
		//retour du tableau à deux dimension
		return $lesInfos;
		}	
	
	
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//---------------------------CREATION DES REQUETES D'INSERTION-------------------------------------------------------------------------------------------------------------------------------------------------
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	public function insertLotClef ($uneDate, $unProfesseur, $unLogiciel,$unEtatReservation) {
		//génération automatique de l'identifiant
		$unCode = $this->donneProchainIdentifiant("Lot_Key","codeLotKey");
		//définition de la requête SQL
		$requete = "INSERT INTO Lot_Key VALUES (";
		$requete .= $unCode.",'";
		$requete .= $uneDate."','";
		$requete .= $unProfesseur."',";
		$requete .= $unLogiciel.",'";
		$requete .= $unEtatReservation."')";
		//Exécution de la requête SQL
		$this->execRequete($requete);
		//retour de l'identifiant du nouveau tuple
		return $unCode;
		}
		
	public function insertClef ($unCode, $unLotClef, $uneClef){
		//définition de la requête SQL
		$requete  = "INSERT INTO Clef VALUES (";
		$requete .= $unCode.",'";
		$requete .= $unLotClef."','";
		$requete .= $uneClef."',";
		$requete .= "'oui')";	
		//exécution de la requête SQL
		$this->execRequete($requete);
		//retour de l'identifiant du nouveau tuple
		return $unCode;
		}
		
	public function insertLogiciel ($unLibelle){
		//génération automatique de l'identifiant
		$unCode = $this->donneProchainIdentifiant("Logiciel", "codeLogiciel");
		//Définition de la requête SQL
		$requete = "INSERT INTO Logiciel VALUES (";
		$requete .= $unCode.",'";
		$requete .= $unLibelle."')";
		//Excécution de la requête SQL
		$this->execRequete($requete);
		return $unCode;
		}
		
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//-----------------------------EXECUTION D'UNE REQUETE---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	private function execRequete($uneRequete){
		$resultat = $this->connexion()->query($uneRequete);
		return $resultat;
		}
	
	
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	//-----------------------------DONNE LE PROCHAIN INDENTIFIANT---------------------------------------------------------------------------------------------------------------------------------------------------------------
	//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	public function donneProchainIdentifiant($uneTable,$unIdentifiant){
		$prochainId[0]=0;
		//définition de la requête SQL
		$requete="SELECT MAX(".$unIdentifiant.") FROM ".$uneTable;
		//exécution de la requête SQL
		$resultat=$this->execRequete($requete);
		$prochainId = $resultat->fetch_row();
		//retour de l'identifiant suivant (+1)
		return $prochainId[0]+1;
		}
	
	public function lesClefsDunLotClef($unCode){
		$req="select * from Clef where codeLotKey=".$unCode;
		$resultat=$this->execRequete($req);
		return $resultat;
		}
	}

?>